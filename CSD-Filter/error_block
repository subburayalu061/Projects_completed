module error_block (
    input wire clk,
    input wire rst_n,
    input wire enable,
    input wire signed [7:0] actual_output,
    input wire signed [7:0] desired_output,
    output reg signed [7:0] error,
    output reg [7:0] error_mag,
    output reg error_sign,
    output reg [15:0] mse
);

    reg signed [7:0] error_prev;
    reg [15:0] squared_error_sum;
    reg [7:0] sample_count;
    
    wire signed [7:0] error_comb = desired_output - actual_output;
    wire [7:0] error_mag_comb = error_comb[7] ? -error_comb : error_comb;
    wire [15:0] squared_error = error_comb * error_comb;
    
    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            error <= 8'b0;
            error_mag <= 8'b0;
            error_sign <= 1'b0;
            squared_error_sum <= 16'b0;
            sample_count <= 8'b0;
            mse <= 16'b0;
        end else if (enable) begin
            error <= error_comb;
            error_sign <= error_comb[7];
            error_mag <= error_mag_comb;
            
            
            squared_error_sum <= squared_error_sum + squared_error;
            sample_count <= sample_count + 1;
            
            if (sample_count > 0) begin
                mse <= squared_error_sum / sample_count;
            end
        end
    end
endmodule
