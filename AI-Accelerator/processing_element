module processing_element(
    input wire clk,
    input wire reset_n,
    input wire signed [31:0] data_in,
    input wire signed [31:0] weight_in,
    input wire signed [63:0] psum_in,
    input wire load_weight,
    input wire clear_psum,
    input wire enable_mac,
    output reg signed [31:0] data_out,
    output reg signed [31:0] weight_out,
    output reg signed [63:0] psum_out,
    output reg overflow
);

reg signed [31:0] data_reg;
reg signed [31:0] weight_reg;
reg signed [63:0] psum_reg;

wire signed [63:0] product;
wire signed [63:0] sum_result;
wire overflow_condition;

assign product = data_reg * weight_reg;
assign sum_result = psum_reg + product;
assign overflow_condition = ((psum_reg[63] == product[63]) && (sum_result[63] != psum_reg[63]));

always @(posedge clk or negedge reset_n) begin
    if (!reset_n) begin
        data_reg <= 32'sd0;
        weight_reg <= 32'sd0;
        psum_reg <= 64'sd0;
        data_out <= 32'sd0;
        weight_out <= 32'sd0;
        psum_out <= 64'sd0;
        overflow <= 1'b0;
    end else begin
        data_reg <= data_in;
        data_out <= data_reg;

        if (load_weight)
            weight_reg <= weight_in;
        weight_out <= weight_reg;

        if (clear_psum)
            psum_reg <= 64'sd0;
        else if (enable_mac)
            psum_reg <= sum_result;
        psum_out <= psum_reg;

        overflow <= overflow_condition && enable_mac && !clear_psum;
    end
end

endmodule
